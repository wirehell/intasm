#def    x_size  80
#def    y_size  43

#def    world_size x_size * y_size

#def    new_cell 79
#def    old_cell 80

#def    new_space 46
#def    old_space 47

        jit [true], init    ; Entry point

; ------------------ Global vars -----------------------------
.false  dw 0                ; Helper for non conditional jumps
.true   dw 1                ;   - " -

.source dw 0                ; Pointer to current buffer
.dest   dw 0                ; Pointer to next gen buffer
;------------------- End of global vars ------------------------

;------------------------ Init ---------------------------------
.i1     dw 0
.i2     dw 0
.ieq    dw 0
.init   add world, 0, [source]              ; Setup source pointer
        add world, world_size, [dest]       ; Setup dest pointer
        add [dest], 0, [i1]                 ;

.l      add [i1], -1, [i1]                  ; i1--
        add [i1], world_size, [i2]          ; setup target

                                            ; Self modifying code test..
        add [i1], 0 , [copyi+1]             ; Rewrite source pos parameter in instruction below
        add [i2], 0 , [copyi+3]             ; Rewrite target pos parameter in instruction below
.copyi  add [0], 0, [0]                     ; Dummy values, but modes needs to be correct

        eq world, [i1], [ieq]
        jit [ieq], l                         ; while i1 != dest (copy from top to bottom)

;----------------------- Init End ------------------------------
        jit [true], print

.main   halt
; Evaluate source to dest
; Flip buffers
; Print
        jif [false], main


;--------------------- Printing ----------------------------
.py     dw 0                                ; y index
.px     dw 0                                ; z index
.pi     dw 0
.pc     dw 0                                ; Conditions
.base   dw 0
.tmp    dw 0

.print  add world, 0, [pi]                  ; i = dest
        add y_size, 0, [py]                 ; y = y_size
.ply    add [py], -1, [py]                  ; y = y-1
        add x_size, 0, [px]                 ; x = x_size
.plx    add [px], -1, [px]                  ; x = x-1
        ; add new check

        out [px]
        out [py]

        add [pi], 0, [cp+1]                 ; Modify source of instruction below
.cp     add [0], 0, [tmp]                   ; Dummy source, copy

        eq [tmp], 79, [tmp]
        out [tmp]

        add [pi], 1, [pi]                   ; i++

        jit [px], plx                       ; while x != 0
        jit [py], ply                       ; while y != 0

        ; output ball                       ; for sync and non breaking
        ; output paddle                     :  - " -

        jit [true], main                   ;return

; -------------------- End of Printing ---------------------------

.world  dw "................................................................................"
        dw "................................................................................"
        dw "................................................................................"
        dw "................................................................................"
        dw "................................................................................"
        dw "......................................OO........................OO.............."
        dw "......................................OO........................OO.............."
        dw "........................................................OO......................"
        dw ".......................................................O..O....................."
        dw "........................................................OO......................"
        dw "................................................................................"
        dw "...................................................OOO.........................."
        dw "...................................................O.O.........................."
        dw "........................OO.........................OOO.........................."
        dw "........................OO.........................OO..........................."
        dw ".......................O..O.......................OOO..........................."
        dw ".......................O..O.OO....................O.O..........................."
        dw ".......................O....OO....................OOO..........................."
        dw ".........................OO.OO.................................................."
        dw "..............................................OO................................"
        dw "....................................OO.......O..O..............................."
        dw "....................................OO........OO................................"
        dw "................................................................OO.............."
        dw "................................................................OO.............."
        dw "................................................................................"
        dw "...................OO..................O........................................"
        dw "...............OO....OOOO..........OO..OO.OOO..................................."
        dw "...............OO..OO.OOO..........OO....OOOO..................................."
        dw "...................O...................OO......................................."
        dw "................................................................................"
        dw "................................................................................"
        dw "................................................................................"
        dw "................................................................................"
        dw "................................................................................"

